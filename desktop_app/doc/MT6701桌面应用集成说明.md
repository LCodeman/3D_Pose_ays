# MT6701 磁编码器桌面应用集成说明

## 更新概述

已成功将MT6701磁编码器支持集成到桌面应用中，版本升级至 **v2.1**。

## 更新内容

### 1. 数据获取模块 (network/data_fetcher.py)

**修改内容：**
- ✅ 添加MT6701可选数据字段支持 (`angle`, `angleRaw`, `angleValid`)
- ✅ 保持向后兼容：没有MT6701的旧版固件仍可正常使用
- ✅ 增强数据验证逻辑

**代码变更：**
```python
# 验证数据完整性
required_keys = ['accelX', 'accelY', 'accelZ', 
               'gyroX', 'gyroY', 'gyroZ', 'temperature']

# MT6701角度数据是可选的（向后兼容）
optional_keys = ['angle', 'angleRaw', 'angleValid']
```

### 2. 主窗口界面 (ui/main_window.py)

**新增功能：**

#### 2.1 窗口标题更新
```
旧: ICM42688-P 3D姿态可视化系统
新: ICM42688-P + MT6701 3D姿态可视化系统
```

#### 2.2 MT6701显示组件

**新增控制面板组：🧭 MT6701 磁编码器**
- 角度显示 (0-360°)
- 原始值显示 (0-16383)
- 状态指示器
  - 🟢 正常 - 数据有效
  - 🔴 无效 - 传感器故障
  - ⚪ 未安装 - 旧版固件

![MT6701显示示例](示例界面.png)

#### 2.3 实时曲线图支持

**菜单栏新增项：**
- 视图 → 实时曲线图 → MT6701角度

**功能特性：**
- 显示0-360°角度实时变化
- 150个数据点缓存
- 参考线标记 (0°, 90°, 180°, 270°, 360°)
- 与其他曲线图窗口自动堆叠

#### 2.4 关于对话框更新
- 版本号: v2.1 (MT6701磁编码器支持)
- 功能列表添加"支持MT6701磁编码器角度监测"

### 3. 实时曲线图模块 (ui/realtime_plot.py)

**新增类：**
```python
class EncoderAnglePlot(RealtimePlotWidget):
    """MT6701磁编码器角度曲线图"""
```

**特性：**
- 单通道黄色曲线 (#ffd93d)
- 0-360°固定范围
- 水平参考线 (0°, 90°, 180°, 270°, 360°)
- 150点数据缓存
- 暗色主题适配

## 使用指南

### 启动桌面应用

```bash
cd /Users/liuxiang/mac/Code/3D_Pose_ays/desktop_app
python main.py
```

### 连接设备

1. 确保ESP32已上传最新固件（包含MT6701支持）
2. 在桌面应用中输入ESP32的IP地址
3. 点击"连接设备"

### 查看MT6701数据

**方法1：控制面板**
- 右侧面板会显示"🧭 MT6701 磁编码器"组
- 实时显示角度和原始值
- 状态指示器显示传感器状态

**方法2：实时曲线图**
1. 菜单栏 → 视图 → 实时曲线图 → MT6701角度
2. 弹出停靠窗口，显示角度变化曲线
3. 可拖动窗口到任意位置
4. 自动保存窗口位置

## 兼容性说明

### 向后兼容

**旧版固件（无MT6701）:**
- ✅ 完全兼容
- ✅ MT6701组件显示"未安装"
- ✅ 不影响其他功能

**新版固件（有MT6701）:**
- ✅ 自动检测并显示角度数据
- ✅ 如果MT6701未连接，显示"无效"状态

### 数据格式

**ESP32 JSON响应（带MT6701）:**
```json
{
  "accelX": 0.001,
  "accelY": -0.002,
  "accelZ": 1.000,
  "gyroX": 0.12,
  "gyroY": -0.05,
  "gyroZ": 0.00,
  "temperature": 25.3,
  "angle": 123.45,
  "angleRaw": 5678,
  "angleValid": true,
  "isValid": true
}
```

**ESP32 JSON响应（无MT6701）:**
```json
{
  "accelX": 0.001,
  "accelY": -0.002,
  "accelZ": 1.000,
  "gyroX": 0.12,
  "gyroY": -0.05,
  "gyroZ": 0.00,
  "temperature": 25.3,
  "isValid": true
}
```

## 界面布局

### 控制面板（右侧）

```
┌─────────────────────────────┐
│  🚀 姿态监控面板             │
├─────────────────────────────┤
│  📡 连接设置                 │
│  ├ 设备IP                   │
│  └ 连接按钮                 │
├─────────────────────────────┤
│  📐 姿态角度                 │
│  ├ Roll                     │
│  ├ Pitch                    │
│  └ Yaw                      │
├─────────────────────────────┤
│  📊 传感器数据               │
│  ├ 加速度 X/Y/Z             │
│  └ 陀螺仪 X/Y/Z             │
├─────────────────────────────┤
│  🧭 MT6701 磁编码器    ← 新增 │
│  ├ 角度: 123.45°           │
│  ├ 原始值: 5678/16383      │
│  └ 状态: 🟢 正常           │
├─────────────────────────────┤
│  🌡️ 温度                    │
│  └ 25.3°C                  │
├─────────────────────────────┤
│  🎨 显示设置                 │
│  └ 模型选择                 │
├─────────────────────────────┤
│  ⚙️ 控制                    │
│  └ 重置姿态                 │
└─────────────────────────────┘
```

### 曲线图窗口（可选，停靠式）

```
左侧停靠区域（可自由拖动）：
┌──────────────────────┐
│  加速度计曲线         │
│  (X/Y/Z三条曲线)     │
├──────────────────────┤
│  陀螺仪曲线           │
│  (X/Y/Z三条曲线)     │
├──────────────────────┤
│  姿态角曲线           │
│  (Roll/Pitch/Yaw)   │
├──────────────────────┤
│  MT6701角度曲线  ← 新增│
│  (0-360°单条曲线)   │
└──────────────────────┘
```

## 测试验证

### 测试步骤

1. **无MT6701设备测试**
   ```bash
   # 使用旧版固件
   python main.py
   # 预期: MT6701组显示"⚪ 未安装"
   ```

2. **有MT6701设备测试**
   ```bash
   # 使用新版固件
   python main.py
   # 预期: MT6701组显示实时角度
   ```

3. **曲线图测试**
   ```bash
   # 打开MT6701角度曲线图
   菜单栏 → 视图 → 实时曲线图 → MT6701角度
   # 预期: 弹出曲线图窗口，显示0-360°范围
   # 旋转磁铁，观察曲线变化
   ```

### 测试检查点

- [ ] 控制面板正确显示MT6701组件
- [ ] 角度值在0-360°范围内
- [ ] 原始值在0-16383范围内
- [ ] 状态指示器正确反映连接状态
- [ ] 曲线图可正常打开和关闭
- [ ] 曲线平滑且无抖动
- [ ] 旧版固件仍可正常工作
- [ ] 窗口布局合理，无重叠

## 技术细节

### 数据流程

```
ESP32 (MT6701)
    ↓ HTTP GET /data
DataFetcher (后台线程)
    ↓ pyqtSignal
MainWindow.on_data_received()
    ↓
    ├→ 更新控制面板标签
    ├→ 更新3D模型姿态
    └→ 更新实时曲线图
        └→ EncoderAnglePlot.add_data()
```

### 性能优化

- 使用deque缓冲区，自动限制数据点数量
- 曲线图只在可见时更新
- 深色主题优化，降低眼睛疲劳
- 自适应窗口高度，适配不同屏幕

## 依赖包

无需额外安装，所有依赖已包含在原requirements.txt中：
- PyQt5 >= 5.15.0
- matplotlib >= 3.5.0
- numpy >= 1.21.0
- requests >= 2.26.0
- PyOpenGL >= 3.1.5

## 常见问题

### Q1: MT6701组件显示"未安装"
**A:** 检查ESP32固件是否为最新版本（包含MT6701支持）

### Q2: 角度显示"N/A"或"无效"
**A:** 
- 检查MT6701硬件连接（SDA→GPIO5, SCL→GPIO6）
- 检查磁铁是否正确安装
- 检查I2C通信是否正常（串口监视器查看）

### Q3: 曲线图不显示数据
**A:** 
- 确认angleValid为true
- 检查"视图→实时曲线图→MT6701角度"是否勾选
- 检查曲线图窗口是否被隐藏

### Q4: 角度跳变或不稳定
**A:**
- 检查磁铁距离（应为1-2mm）
- 检查磁铁对中
- 远离强磁场干扰源

## 更新日志

**v2.1 (2025-10-22)**
- ✅ 添加MT6701磁编码器支持
- ✅ 新增角度显示组件
- ✅ 新增角度实时曲线图
- ✅ 保持向后兼容性
- ✅ 更新关于对话框

**v2.0 (之前)**
- 四元数Madgwick算法
- 3D模型导入
- 实时曲线图

## 下一步开发建议

1. **多圈计数**: 添加MT6701多圈角度累计功能
2. **角度校准**: 添加零点校准和角度偏移设置
3. **数据导出**: 支持导出MT6701角度数据到CSV
4. **告警功能**: 角度超限时触发提醒
5. **速度计算**: 根据角度变化计算转速(RPM)

## 相关文档

- [MT6701磁编码器使用说明](MT6701磁编码器使用说明.md)
- [3D模型格式说明](3D模型格式说明.md)
- [四元数算法优化说明](四元数算法优化说明.md)
- [实时曲线图使用说明](实时曲线图使用说明.md)

---

**更新日期**: 2025-10-22  
**作者**: 3D姿态检测系统开发团队  
**版本**: v2.1

