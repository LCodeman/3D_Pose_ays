# ICM42688-P + MT6701 3D姿态可视化系统

## 项目简介

这是一个基于Python和PyQt5的3D姿态可视化系统，支持：
- **ICM42688-P** 六轴姿态传感器（加速度计+陀螺仪）
- **MT6701** 14位高精度磁编码器

通过ESP32-S3实时采集传感器数据，并在桌面应用中进行可视化显示。

## 版本信息

**当前版本**: v2.1  
**更新日期**: 2025-10-22

## 主要功能

### 1. 实时3D姿态显示
- ✅ 基于四元数Madgwick算法的高精度姿态估计
- ✅ 实时3D模型旋转渲染
- ✅ 支持自定义3D模型导入（OBJ/STL格式）
- ✅ 流畅的60fps渲染

### 2. 传感器数据监控
- ✅ ICM42688-P六轴数据实时显示
  - 加速度（X/Y/Z）
  - 陀螺仪（X/Y/Z）
  - 温度
- ✅ MT6701磁编码器角度监测 **[v2.1新增]**
  - 14位精度（0.022°）
  - 0-360°全周测量
  - 实时状态指示

### 3. 实时曲线图
- ✅ 加速度计曲线（X/Y/Z）
- ✅ 陀螺仪曲线（X/Y/Z）
- ✅ 姿态角曲线（Roll/Pitch/Yaw）
- ✅ MT6701角度曲线 **[v2.1新增]**

### 4. 现代化界面
- ✅ 深色主题，护眼设计
- ✅ 停靠式窗口，自由布局
- ✅ 响应式设计，适配各种屏幕

## 系统架构

```
┌─────────────────────────────────────────────────┐
│                  桌面应用 (PyQt5)                │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  │
│  │ 3D渲染器  │  │ 控制面板  │  │ 曲线图    │  │
│  │ OpenGL    │  │ 传感器显示│  │ Matplotlib│  │
│  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘  │
│        │              │              │         │
│        └──────────────┴──────────────┘         │
│                       ▲                        │
└───────────────────────┼────────────────────────┘
                        │ HTTP (JSON)
┌───────────────────────┼────────────────────────┐
│              ESP32-S3 (固件)                   │
│  ┌────────────┐  ┌────────────┐  ┌─────────┐ │
│  │ ICM42688-P │  │  MT6701    │  │ WiFi    │ │
│  │    SPI     │  │    I2C     │  │ Server  │ │
│  └────────────┘  └────────────┘  └─────────┘ │
└────────────────────────────────────────────────┘
```

## 硬件连接

### ESP32-S3引脚分配

| 传感器 | 引脚 | ESP32-S3 GPIO | 说明 |
|--------|------|---------------|------|
| **ICM42688-P** | CS | GPIO 11 | SPI片选 |
| | SCK | GPIO 10 | SPI时钟 |
| | MISO | GPIO 8 | SPI数据输入 |
| | MOSI | GPIO 9 | SPI数据输出 |
| | VDD | 3.3V | 电源 |
| | GND | GND | 地线 |
| **MT6701** | SDA | GPIO 5 | I2C数据 |
| | SCL | GPIO 6 | I2C时钟 |
| | PWM | GPIO 7 | PWM输出（可选）|
| | VDD | 3.3V/5V | 电源 |
| | GND | GND | 地线 |

## 安装指南

### 1. 系统要求

- Python 3.8 或更高版本
- macOS / Windows / Linux
- 显卡支持OpenGL 2.1+

### 2. 安装依赖

```bash
cd desktop_app
pip install -r requirements.txt
```

### 3. 依赖包列表

- PyQt5 >= 5.15.0
- PyOpenGL >= 3.1.5
- numpy >= 1.21.0
- matplotlib >= 3.5.0
- requests >= 2.26.0
- numpy-stl >= 2.16.0

## 使用指南

### 1. 启动应用

```bash
cd desktop_app
python main.py
```

### 2. 连接ESP32设备

1. 确保ESP32已上传固件并连接到WiFi
2. 在应用右侧输入ESP32的IP地址
3. 点击"🔌 连接设备"按钮
4. 等待连接成功提示

### 3. 查看数据

**控制面板（右侧）:**
- 📐 姿态角度: Roll/Pitch/Yaw
- 📊 传感器数据: 加速度/陀螺仪
- 🧭 MT6701角度: 实时角度值
- 🌡️ 温度: 芯片温度

**3D视图（中央）:**
- 鼠标左键拖拽: 旋转视角
- 鼠标滚轮: 缩放
- 实时显示姿态变化

**实时曲线图（菜单打开）:**
- 菜单栏 → 视图 → 实时曲线图
- 可选择：加速度计/陀螺仪/姿态角/MT6701角度
- 窗口可自由拖动和停靠

### 4. 导入自定义3D模型

1. 菜单栏 → 文件 → 导入3D模型
2. 选择OBJ或STL格式文件
3. 模型自动加载并显示

### 5. 快捷键

| 快捷键 | 功能 |
|--------|------|
| Ctrl+O | 导入3D模型 |
| Ctrl+R | 重置视角 |
| Ctrl+Q | 退出程序 |

## 核心算法

### 四元数Madgwick算法

本系统使用四元数Madgwick算法进行姿态估计，具有以下优势：

1. **避免万向节锁**: 四元数表示无奇异点
2. **高性能**: 计算效率比旋转矩阵高40%
3. **数值稳定**: 适合实时计算
4. **平滑插值**: 姿态变化更流畅

**参数配置:**
```python
beta = 0.1          # 陀螺仪偏差校正增益
sample_freq = 10    # 采样频率 (Hz)
```

## 目录结构

```
desktop_app/
├── main.py                 # 主程序入口
├── requirements.txt        # Python依赖
├── README.md              # 本文件
│
├── 3d/                    # 3D渲染模块
│   ├── models.py         # 3D模型定义
│   └── renderer.py       # OpenGL渲染器
│
├── ui/                    # 用户界面
│   ├── main_window.py    # 主窗口
│   └── realtime_plot.py  # 实时曲线图
│
├── network/               # 网络通信
│   └── data_fetcher.py   # ESP32数据获取
│
├── utils/                 # 工具函数
│   ├── quaternion.py     # 四元数算法
│   └── model_loader.py   # 模型加载器
│
├── assets/                # 资源文件
│   └── STHeiti Light.ttc # 中文字体
│
└── doc/                   # 文档
    ├── MT6701磁编码器使用说明.md
    ├── MT6701桌面应用集成说明.md
    ├── 3D模型格式说明.md
    ├── 四元数算法优化说明.md
    └── 实时曲线图使用说明.md
```

## 配置文件

### ESP32连接配置

默认连接地址：`http://192.168.3.57/data`

可在主窗口的"连接设置"组中修改。

### 数据刷新率

默认：100ms（10Hz）

可在`network/data_fetcher.py`中修改：
```python
DataFetcher(url, interval=100)  # 单位: 毫秒
```

## 故障排查

### 常见问题

**Q1: 无法连接ESP32**
- 检查ESP32 WiFi是否连接
- 检查IP地址是否正确
- ping ESP32 IP地址测试网络连通性

**Q2: 3D模型不显示**
- 检查显卡驱动是否支持OpenGL
- 尝试导入不同的3D模型
- 查看终端错误信息

**Q3: MT6701显示"未安装"**
- 检查ESP32固件版本（需v2.1+）
- 检查MT6701硬件连接
- 查看ESP32串口监视器日志

**Q4: 曲线图窗口无法打开**
- 检查matplotlib是否正确安装
- 重启应用程序
- 查看终端错误信息

**Q5: 中文显示乱码**
- 检查`assets/STHeiti Light.ttc`字体文件是否存在
- 系统需支持中文字体

## 性能优化建议

1. **降低数据刷新率**: 如果CPU占用高，可降低刷新率到200ms
2. **关闭不需要的曲线图**: 只打开需要的曲线图窗口
3. **简化3D模型**: 使用低面数的3D模型
4. **调整曲线图缓冲**: 减少`max_points`参数

## 开发指南

### 添加新的传感器

1. 在ESP32固件中添加传感器读取代码
2. 在JSON响应中添加新字段
3. 在`data_fetcher.py`中添加字段验证
4. 在`main_window.py`中创建显示组件
5. （可选）在`realtime_plot.py`中添加曲线图

### 自定义主题

修改`main_window.py`中的`set_dark_theme()`方法：
```python
def set_dark_theme(self):
    self.setStyleSheet("""
        QMainWindow {
            background-color: #1a1a1a;  # 修改背景色
        }
        /* ... 其他样式 ... */
    """)
```

## 许可证

本项目为教育和研究目的开发。

## 致谢

- **ICM42688-P**: TDK InvenSense
- **MT6701**: MagnTek
- **PyQt5**: Riverbank Computing
- **Matplotlib**: Matplotlib Development Team

## 联系方式

如有问题或建议，请参考文档或查看源代码注释。

---

**祝使用愉快！** 🚀
